import{f as W}from"./dateUtil-Yht9XRPF.js";import{c as t,x as w,bu as X,a6 as Y,r as p,ap as O,a7 as I,aq as x,d as ee,o as te,b as ae,n as N,q as E,E as r,y as oe,F as T,J as le,L as m,A as re}from"./index-DfFq98iI.js";import{P as se,_ as ne}from"./index-Cd8zMccQ.js";import{T as h}from"./index-Dlnok0kj.js";import{a as C,F as ue}from"./index-DgRcuS_8.js";import{S as P}from"./index-B8_A7MkL.js";import{_ as ie}from"./index.vue_vue_type_style_index_0_lang-BfNlMPF9.js";import{u as de}from"./dynamic-table-BvYG2uaQ.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-DfpO8rn_.js";import{S as ce}from"./index-LC6BztS_.js";import{A as me}from"./index-BkBUef85.js";import{P as pe}from"./index-BBU6WuBs.js";import{_ as fe}from"./index-SgyRZT1f.js";let i=function(a){return a.SUCCESS="success",a.ERROR="error",a.UPLOADING="uploading",a}({});const Ae=[{title:"文件名",dataIndex:"name",width:150,ellipsis:!0,customRender({record:a}){return t(Y,null,{title:()=>a.path,default:()=>t("a",{href:X+a.path,target:"_blank"},[a.name])})}},{title:"文件后缀",dataIndex:"extName",width:80},{title:"目录",dataIndex:"type",width:80},{title:"大小",dataIndex:"size",width:80,customRender:({record:a})=>t(h,{color:"blue"},{default:()=>[a.size]})},{title:"上传者",dataIndex:"username",width:120},{title:"创建时间",dataIndex:"createdAt",width:160,customRender:({record:a})=>W(a.createdAt)},{title:"操作",width:130,dataIndex:"ACTION",hideInSearch:!0,fixed:"right",actions:({record:a})=>[{label:"生成Database",onClick:async()=>{const s=p({name:"",fileType:"",description:""}),y=p(),_=[{label:"CSV",value:"csv"},{label:"Excel",value:"excel"},{label:"JSON",value:"json"},{label:"Parquet",value:"parquet"},{label:"ORC",value:"orc"}];O.confirm({title:"生成Database",content:()=>t(C,{ref:y,model:s.value,layout:"vertical"},{default:()=>[t(C.Item,{label:"Database名称",name:"name",rules:[{required:!0,type:"string",message:"请输入Database名称"},{pattern:/^[a-zA-Z0-9_]+$/,message:"名称只能包含字母、数字和下划线"}]},{default:()=>[t(I,{value:s.value.name,"onUpdate:value":l=>s.value.name=l,placeholder:"请输入Database名称",maxlength:50},null)]}),t(C.Item,{label:"文件类型",name:"fileType",rules:[{required:!0,message:"请选择文件类型"}]},{default:()=>[t(P,{value:s.value.fileType,"onUpdate:value":l=>s.value.fileType=l,placeholder:"请选择文件类型",style:"width: 100%;",options:_},null)]}),t(C.Item,{label:"Database描述",name:"description",rules:[{required:!0,message:"请输入Database描述"}]},{default:()=>[t(I.TextArea,{value:s.value.description,"onUpdate:value":l=>s.value.description=l,placeholder:"请输入Database描述",maxlength:500,showCount:!0,rows:4},null)]})]}),okText:"确定",cancelText:"取消",onOk:async()=>{var l;try{await((l=y.value)==null?void 0:l.validate()),await x.ai.addDatabase({type:"file",name:s.value.name.trim(),description:s.value.description.trim(),enabled:1,rag_names:[],config:JSON.stringify({file_type:s.value.fileType,file_system:"file",file_path:a.type+"/"+a.name})})}catch(d){return Promise.reject(d)}}})}}]}],ve=[{dataIndex:"name",title:"文件名",align:"left",customRender:({text:a,record:s})=>{const{percent:y,status:_}=s||{};let l="normal";return _===i.ERROR?l="exception":_===i.UPLOADING?l="active":_===i.SUCCESS&&(l="success"),t("div",null,[t("p",{class:"truncate mb-1 max-w-[280px]",title:a},[a]),t(se,{percent:y,size:"small",status:l},null)])}},{dataIndex:"size",title:"文件大小",width:100,customRender:({text:a=0})=>a&&`${(a/1024).toFixed(2)}KB`},{dataIndex:"status",title:"状态",width:100,customRender:({text:a})=>a===i.SUCCESS?t(h,{color:"green"},{default:()=>[w("上传成功")]}):a===i.ERROR?t(h,{color:"red"},{default:()=>[w("上传失败")]}):a===i.UPLOADING?t(h,{color:"blue"},{default:()=>[w("上传中")]}):a||"待上传"}],Ne=[{field:"name",label:"名称",component:"Input",colProps:{span:8}}],ye={key:0,class:"text-gray-500 text-sm mt-2"},k=400,Ee=ee({__name:"upload-modal",emits:["uploadSuccess","updateDirectory"],setup(a,{emit:s}){const y=s,[_]=de(),l=p(!1),d=p([]),n=p(""),S=p(!1),b=p({directoryName:""}),R=p(),D=p([]),g=async()=>{const o=await x.toolsUpload.getDirectories();D.value=o.map(e=>({label:e,value:e}))};te(async()=>{await g()});const B=ae(()=>!d.value.some(o=>o.status!==i.SUCCESS)),z=o=>{const{promise:e,resolve:u,reject:f}=Promise.withResolvers(),v=new FileReader;return v.onload=()=>{u(v.result)},v.onerror=F=>{f(F)},v.readAsDataURL(o),e},q=()=>{d.value.some(e=>e.status===i.SUCCESS)&&y("uploadSuccess"),d.value=[],n.value=""},L=async()=>{if(!n.value){m.error("请先选择目录");return}const o=d.value.filter(e=>e.status!==i.SUCCESS);await Promise.all(o.map(async e=>{try{await x.toolsUpload.uploadUpload({file:e.file,directory:e.directory},void 0,{onUploadProgress(u){const f=u.loaded/u.total*100|0;e.percent=f,e.status=i.UPLOADING}}),e.status=i.SUCCESS}catch(u){e.status=i.ERROR}}))},$=async o=>{if(!n.value)return m.error("请先选择目录"),!1;if(o.size/1024/1024>k)m.error(`单个文件不超过${k}MB`);else{const e={file:o,uid:o.uid,name:o.name,size:o.size,status:"",percent:0,thumbUrl:await z(o),directory:n.value};d.value.push(e)}return!1},M=o=>{d.value=d.value.filter(e=>e.uid!==o.uid)},V=async()=>{var f;if(await((f=R.value)==null?void 0:f.validate()),!b.value.directoryName.trim()){m.error("请输入目录名称");return}if(!/^[a-zA-Z0-9_\u4e00-\u9fa5-]+$/.test(b.value.directoryName.trim())){m.error("目录名称只能包含字母、数字、中文、下划线和连字符");return}const e=b.value.directoryName.trim();if(D.value.some(v=>v.value===e)){m.error("目录已存在");return}await x.toolsUpload.createDirectory({directoryName:e}),await g(),n.value=e,b.value={directoryName:""},S.value=!1,m.success("目录添加成功")},G=async()=>{if(!n.value){m.error("请先选择要删除的目录");return}await x.toolsUpload.deleteDirectory({directoryName:n.value}),await g(),n.value="",m.success("目录删除成功"),y("updateDirectory")},j=[...ve,{width:120,title:"操作",dataIndex:"ACTION",fixed:!1,actions:({record:o})=>[{label:"删除",color:"red",onClick:()=>M(o)}]}];return(o,e)=>{const u=re("a-button"),f=me,v=P,F=pe,J=fe,U=ue,Z=ne,A=C,K=ce,H=I,Q=O;return N(),E(le,null,[t(u,{type:"primary",disabled:!o.$auth("upload:upload"),onClick:e[0]||(e[0]=c=>l.value=!0)},{default:r(()=>e[6]||(e[6]=[w(" 上传 ")])),_:1},8,["disabled"]),t(T(ie),{open:l.value,"onUpdate:open":e[3]||(e[3]=c=>l.value=c),title:"上传",width:800,"ok-text":"开始上传","ok-button-props":{disabled:B.value},onOk:L,onCancel:q},{default:r(()=>[t(K,{direction:"vertical",style:{width:"100%"}},{default:r(()=>[t(f,{message:"单个文件不超过400MB，最多只能上传10个文件",type:"info","show-icon":""}),t(A,{layout:"vertical"},{default:r(()=>[t(U,{label:"选择目录",required:!0},{default:r(()=>[t(J,{gap:"middle",align:"center"},{default:r(()=>[t(v,{value:n.value,"onUpdate:value":e[1]||(e[1]=c=>n.value=c),placeholder:"请选择目录",style:{flex:"1"},options:D.value},null,8,["value","options"]),t(u,{type:"dashed",onClick:e[2]||(e[2]=c=>S.value=!0)},{default:r(()=>e[7]||(e[7]=[w(" 添加目录 ")])),_:1}),t(F,{title:"确定要删除这个目录吗？","ok-text":"确定","cancel-text":"取消",onConfirm:G},{default:r(()=>[t(u,{type:"dashed",danger:"",disabled:!n.value},{default:r(()=>e[8]||(e[8]=[w(" 删除目录 ")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),t(U,{label:"选择文件"},{default:r(()=>[t(Z,{multiple:!0,"before-upload":$,"show-upload-list":!1,disabled:!n.value},{default:r(()=>[t(u,{type:"primary",disabled:!n.value},{default:r(()=>e[9]||(e[9]=[w(" 选择文件 ")])),_:1},8,["disabled"])]),_:1},8,["disabled"]),n.value?oe("",!0):(N(),E("div",ye," 请先选择目录后再选择文件 "))]),_:1})]),_:1})]),_:1}),t(T(_),{search:!1,"data-source":d.value,columns:j},null,8,["data-source"])]),_:1},8,["open","ok-button-props"]),t(Q,{open:S.value,"onUpdate:open":e[5]||(e[5]=c=>S.value=c),title:"添加目录","ok-text":"确定","cancel-text":"取消",onOk:V},{default:r(()=>[t(A,{ref_key:"directoryFormRef",ref:R,model:b.value,layout:"vertical"},{default:r(()=>[t(U,{label:"目录名称",name:"directoryName",rules:[{required:!0,message:"请输入目录名称"},{pattern:/^[a-zA-Z0-9_\u4e00-\u9fa5-]+$/,message:"目录名称只能包含字母、数字、中文、下划线和连字符"}]},{default:r(()=>[t(H,{value:b.value.directoryName,"onUpdate:value":e[4]||(e[4]=c=>b.value.directoryName=c),placeholder:"请输入目录名称（支持中文、字母、数字、下划线、连字符）",maxlength:50,"show-count":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])],64)}}});export{Ee as _,Ae as b,Ne as s};
