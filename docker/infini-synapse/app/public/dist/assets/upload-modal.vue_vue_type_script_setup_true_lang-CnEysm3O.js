import{f as y}from"./dateUtil-DqkXadUR.js";import{c as s,G as p,bh as S,a8 as O,d as k,r as C,e as F,q as P,v as T,E as m,F as w,K as D,as as L,M as N,A as z}from"./index-BOVJKpu-.js";import{I as R}from"./index-DmkYAtCw.js";import{P as B,_ as G}from"./index-CMx4Cwh_.js";import{T as f}from"./index-hRRSkng1.js";import{_ as $}from"./index.vue_vue_type_style_index_0_lang-DXTL-s1_.js";import{u as M}from"./dynamic-table-CPcE651L.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-DrLV2jX6.js";import{A as j}from"./index-47Va5tV1.js";import{_ as K}from"./index-DxYKQPPX.js";let o=function(e){return e.SUCCESS="success",e.ERROR="error",e.UPLOADING="uploading",e}({});const ae=[{title:"文件名",dataIndex:"name",width:150,ellipsis:!0,customRender({record:e}){return s(O,null,{title:()=>e.path,default:()=>s("a",{href:S+e.path,target:"_blank"},[e.name])})}},{title:"预览图",dataIndex:"path",width:150,customRender({record:e}){return s(R,{src:S+e.path},null)}},{title:"文件后缀",dataIndex:"extName",width:80},{title:"类别",dataIndex:"type",width:80},{title:"大小",dataIndex:"size",width:80,customRender:({record:e})=>s(f,{color:"blue"},{default:()=>[e.size]})},{title:"上传者",dataIndex:"username",width:120},{title:"创建时间",dataIndex:"createdAt",width:160,customRender:({record:e})=>y(e.createdAt)}],V=[{dataIndex:"thumbUrl",title:"缩略图",width:100,customRender:({record:e})=>{const{thumbUrl:u}=e;return u&&s(R,{src:u},null)}},{dataIndex:"name",title:"文件名",align:"left",customRender:({text:e,record:u})=>{const{percent:_,status:d}=u||{};let l="normal";return d===o.ERROR?l="exception":d===o.UPLOADING?l="active":d===o.SUCCESS&&(l="success"),s("div",null,[s("p",{class:"truncate mb-1 max-w-[280px]",title:e},[e]),s(B,{percent:_,size:"small",status:l},null)])}},{dataIndex:"size",title:"文件大小",width:100,customRender:({text:e=0})=>e&&`${(e/1024).toFixed(2)}KB`},{dataIndex:"status",title:"状态",width:100,customRender:({text:e})=>e===o.SUCCESS?s(f,{color:"green"},{default:()=>[p("上传成功")]}):e===o.ERROR?s(f,{color:"red"},{default:()=>[p("上传失败")]}):e===o.UPLOADING?s(f,{color:"blue"},{default:()=>[p("上传中")]}):e||"待上传"}],se=[{field:"name",label:"名称",component:"Input",colProps:{span:8}}],oe=k({__name:"upload-modal",emits:["uploadSuccess"],setup(e,{emit:u}){const _=u,[d]=M(),l=C(!1),r=C([]),v=F(()=>!r.value.some(a=>a.status!==o.SUCCESS)),I=a=>{const{promise:t,resolve:n,reject:c}=Promise.withResolvers(),i=new FileReader;return i.onload=()=>{n(i.result)},i.onerror=b=>{c(b)},i.readAsDataURL(a),t},U=()=>{r.value.some(t=>t.status===o.SUCCESS)&&_("uploadSuccess"),r.value=[]},x=async()=>{const a=r.value.filter(t=>t.status!==o.SUCCESS);await Promise.all(a.map(async t=>{try{await L.toolsUpload.uploadUpload({file:t.file},void 0,{onUploadProgress(n){const c=n.loaded/n.total*100|0;t.percent=c,t.status=o.UPLOADING}}),t.status=o.SUCCESS}catch(n){t.status=o.ERROR}}))},A=async a=>{if(a.size/1024/1024>2)N.error("单个文件不超过2MB");else{const t={file:a,uid:a.uid,name:a.name,size:a.size,status:"",percent:0,thumbUrl:await I(a)};r.value.push(t)}return!1},E=a=>{r.value=r.value.filter(t=>t.uid!==a.uid)},g=[...V,{width:120,title:"操作",dataIndex:"ACTION",fixed:!1,actions:({record:a})=>[{label:"删除",color:"red",onClick:()=>E(a)}]}];return(a,t)=>{const n=z("a-button"),c=j,i=G,b=K;return P(),T(D,null,[s(n,{type:"primary",disabled:!a.$auth("upload:upload"),onClick:t[0]||(t[0]=h=>l.value=!0)},{default:m(()=>t[2]||(t[2]=[p(" 上传 ")])),_:1},8,["disabled"]),s(w($),{open:l.value,"onUpdate:open":t[1]||(t[1]=h=>l.value=h),title:"上传",width:800,"ok-text":"开始上传","ok-button-props":{disabled:v.value},onOk:x,onCancel:U},{default:m(()=>[s(b,{justify:"space-between",align:"center"},{default:m(()=>[s(c,{message:"单个文件不超过2MB，最多只能上传10个文件",type:"info","show-icon":""}),s(i,{multiple:!0,"before-upload":A,"show-upload-list":!1},{default:m(()=>[s(n,{type:"primary"},{default:m(()=>t[3]||(t[3]=[p(" 选择文件 ")])),_:1})]),_:1})]),_:1}),s(w(d),{search:!1,"data-source":r.value,columns:g},null,8,["data-source"])]),_:1},8,["open","ok-button-props"])],64)}}});export{oe as _,ae as b,se as s};
