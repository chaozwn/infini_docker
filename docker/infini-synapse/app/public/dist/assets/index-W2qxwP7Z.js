import{c as p,x as h,aq as a,d as V,D as k,r as f,w as q,a1 as A,am as R,bN as M,ap as z}from"./index-DC40FTKc.js";import{T as _}from"./index-DTl5nX8a.js";import"./index.vue_vue_type_style_index_0_lang-aahum9XG.js";import{u as N}from"./useFormModal-6O15y07k.js";import{u as C}from"./dynamic-table-B-HyaUur.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-BJz2xSfi.js";import"./dateUtil-_088BUty.js";import"./index-8Y4uw6RN.js";import"./useFlexGapSupport-CLd-IHzq.js";import"./debounce-C8iFAAKL.js";import"./index-DZJ1Qjvp.js";import"./index-CHtQ8gDa.js";import"./_baseUniq-CwVVkYJU.js";import"./_arrayIncludesWith-DbV0gfeD.js";import"./collapseMotion-DnBQ0MN3.js";import"./move-BjexSpXc.js";import"./RightOutlined-COUVcat4.js";import"./index-BjjqKe5r.js";import"./index-DMeTr2qs.js";import"./isMobile-BbN7I0i_.js";import"./useMergedState-vsEjai2j.js";import"./DownOutlined-Qh8k9q8f.js";import"./CheckOutlined-D_znL05x.js";import"./VerticalRightOutlined-DS5tklhj.js";import"./cloneDeep-Dji1XI67.js";import"./index-CQmySVEz.js";import"./index-D7CV2fV4.js";import"./_castArrayLikeObject-BUxLfTIJ.js";import"./index-gw3-02RS.js";import"./LeftOutlined-CsuPD2a3.js";import"./zh_CN-CAyhejr6.js";import"./index-C5y0_dCt.js";import"./FileOutlined-DxPUh8pO.js";import"./Text-BBUuUKbr.js";import"./EnterOutlined-B3FaXB-1.js";import"./CopyOutlined-epw8ZA0v.js";import"./index-BInLa-Gq.js";import"./useRefs-CxigKnPp.js";import"./QuestionCircleOutlined-npexNCpY.js";import"./isNumber-BAcH5eHM.js";import"./index-CrZ07gZ0.js";import"./index-B5dihKdL.js";import"./pick-CNtlZoov.js";const G=[{title:"RAG名称(AI使用关键字)",width:100,dataIndex:"name"},{title:"描述(用于AI识别RAG)",dataIndex:"description",width:150},{title:"Type",dataIndex:"product_type",width:80,customRender:({record:o})=>{const u=o.product_type==="lite";return p(_,{color:u?"green":"orange"},{default:()=>[u?"lite":"pro"]})},formItemProps:{component:"Select",componentProps:{options:[{label:"lite",value:"lite"},{label:"pro",value:"pro"}]}}},{title:"模型",dataIndex:"model",hideInSearch:!0,width:80},{title:"Tokenizer路径",dataIndex:"tokenizer_path",hideInSearch:!0,width:80},{title:"文档路径",dataIndex:"doc_dir",hideInSearch:!0,width:80},{title:"RAG文档过滤相关性",dataIndex:"rag_doc_filter_relevance",hideInSearch:!0,width:80},{title:"主机:端口",width:80,dataIndex:"host:port",hideInSearch:!0,customRender:({record:o})=>`${o.host}:${o.port}`},{title:"状态",dataIndex:"status",width:80,customRender:({record:o})=>{switch(o.status){case"running":return p(_,{color:"green"},{default:()=>[h("running")]});case"stopped":return p(_,{color:"red"},{default:()=>[h("stopped")]});case"starting":return p(_,{color:"orange"},{default:()=>[h("starting")]});default:return""}}},{title:"进程ID",dataIndex:"process_id",hideInSearch:!0,width:80}],r=async()=>(await a.ai.getAllModels()??[]).map(l=>({label:l.name,value:l.name})),x=async()=>(await a.toolsUpload.getDirectories()??[]).map(l=>({label:l,value:l})),D=[{field:"name",component:"Input",componentProps:{placeholder:""},label:"RAG名称",rules:[{required:!0,type:"string",message:"请输入RAG名称"},{pattern:/^[a-zA-Z0-9_]+$/,message:"名称只能包含字母、数字和下划线"}]},{field:"description",component:"InputTextArea",label:"RAG功能描述",helpMessage:"RAG的功能描述,将会在Agent的prompt中使用，可以提高模型选择使用rag的准确性",componentProps:{placeholder:"",rows:2},defaultValue:"",rules:[{required:!0,type:"string",message:"请输入RAG的功能描述"}]},{field:"product_type",component:"Select",componentProps:{options:[{label:"轻量版(Lite)",value:"lite"},{label:"专业版(Pro)",value:"pro"}]},defaultValue:"lite",label:"配置类型"},{field:"rag_context_window_limit",component:"InputNumber",label:"模型窗口大小",defaultValue:56e3,componentProps:{placeholder:""},helpMessage:"模型的上下文窗口大小,如果不设置将使用模型的默认值"},{field:"full_text_ratio",component:"InputNumber",label:"全文区占窗口比例",componentProps:{placeholder:"",min:0,step:.1,max:1},defaultValue:.7},{field:"segment_ratio",component:"InputNumber",label:"片断区占窗口比例",componentProps:{placeholder:"",min:0,step:.1,max:1},defaultValue:.2},{field:"model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:""}),label:"主模型",rules:[{required:!0,type:"string",message:"主模型不能为空"}]},{field:"recall_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择召回模型(可选)"}),label:"召回模型",helpMessage:"用户文档检索的模型",defaultValue:""},{field:"chunk_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择抽取模型(可选)"}),label:"抽取模型",helpMessage:"用于文本分块的模型",defaultValue:""},{field:"qa_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择回答模型(可选)"}),label:"回答模型",helpMessage:"用于生成最后回答的模型",defaultValue:""},{field:"tokenizer_path",component:"Input",componentProps:{placeholder:"输入Tokenizer路径(可选)"},label:"Tokenizer路径",defaultValue:""},{field:"doc_dir",component:"Select",componentProps:()=>({request:()=>x(),placeholder:""}),label:"文档目录",rules:[{required:!0,type:"string",message:"请输入文档目录"}]},{field:"rag_doc_filter_relevance",component:"InputNumber",label:"文档过滤相关度",componentProps:{placeholder:"",min:0,step:.1,max:10},defaultValue:2},{field:"host",component:"Input",label:"主机",componentProps:{placeholder:""},defaultValue:"127.0.0.1"},{field:"port",component:"InputNumber",label:"端口",defaultValue:"8000",componentProps:{placeholder:"",min:1024,max:65535}},{field:"required_exts",component:"Select",componentProps:()=>({mode:"tags",placeholder:"输入拓展名并按回车或空格添加(例如:.txt,.pdf)"}),label:"必需的拓展名"},{field:"disable_inference_enhance",component:"Switch",label:"禁用推理增强",defaultValue:!0},{field:"inference_deep_thought",component:"Switch",label:"推理深度思考",defaultValue:!1},{field:"enable_hybrid_index",component:"Switch",label:"启用混合索引加速",helpMessage:"使用此功能需先通过byzerllm storage start 启动一个加速引擎以及创建一个名字为emb的向量模型",defaultValue:!1},{field:"hybrid_index_max_output_tokens",component:"InputNumber",label:"混合索引最大输出token数",componentProps:{min:1,max:1e8},defaultValue:"1000000"},{field:"emb_model",label:"向量模型",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择向量模型"}),rules:[{required:!0,type:"string",message:"请选择向量模型!"}],vIf:o=>o.values.enable_hybrid_index,defaultValue:""},{field:"rag_storage_type",component:"Select",label:"存储引擎类型",helpMessage:"byzer-storage 需要先安装 Byzer 存储引擎",componentProps:{options:[{label:"DuckDB(默认)",value:"duckdb"},{label:"Byzer Storage",value:"byzer-storage"}]},vIf:o=>o.values.enable_hybrid_index,defaultValue:"duckdb"},{field:"without_contexts",component:"Switch",label:"禁用上下文",defaultValue:!1},{field:"enable_local_image_host",component:"Switch",label:"启动本地图片托管",defaultValue:!1}],T=[{field:"description",component:"InputTextArea",label:"RAG功能描述",helpMessage:"RAG的功能描述,将会在Agent的prompt中使用，可以提高模型选择使用rag的准确性",componentProps:{placeholder:"",rows:2},defaultValue:"",rules:[{required:!0,type:"string",message:"请输入RAG的功能描述"}]},{field:"product_type",component:"Select",componentProps:{options:[{label:"轻量版(Lite)",value:"lite"},{label:"专业版(Pro)",value:"pro"}]},defaultValue:"lite",label:"配置类型"},{field:"rag_context_window_limit",component:"InputNumber",label:"模型窗口大小",defaultValue:56e3,componentProps:{placeholder:""},helpMessage:"模型的上下文窗口大小,如果不设置将使用模型的默认值"},{field:"full_text_ratio",component:"InputNumber",label:"全文区占窗口比例",componentProps:{placeholder:"",min:0,step:.1,max:1},defaultValue:.7},{field:"segment_ratio",component:"InputNumber",label:"片断区占窗口比例",componentProps:{placeholder:"",min:0,step:.1,max:1},defaultValue:.2},{field:"model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:""}),label:"主模型",rules:[{required:!0,type:"string",message:"主模型不能为空"}]},{field:"recall_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择召回模型(可选)"}),label:"召回模型",helpMessage:"用户文档检索的模型",defaultValue:""},{field:"chunk_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择抽取模型(可选)"}),label:"抽取模型",helpMessage:"用于文本分块的模型",defaultValue:""},{field:"qa_model",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择回答模型(可选)"}),label:"回答模型",helpMessage:"用于生成最后回答的模型",defaultValue:""},{field:"tokenizer_path",component:"Input",componentProps:{placeholder:"输入Tokenizer路径(可选)"},label:"Tokenizer路径",defaultValue:""},{field:"doc_dir",component:"Select",componentProps:()=>({request:()=>x(),placeholder:""}),label:"文档目录",rules:[{required:!0,type:"string",message:"请输入文档目录"}]},{field:"rag_doc_filter_relevance",component:"InputNumber",label:"文档过滤相关度",componentProps:{placeholder:"",min:0,step:.1,max:10},defaultValue:2},{field:"host",component:"Input",label:"主机",componentProps:{placeholder:""},defaultValue:"127.0.0.1"},{field:"port",component:"InputNumber",label:"端口",defaultValue:8e3,componentProps:{placeholder:"",min:1024,max:65535}},{field:"required_exts",component:"Select",componentProps:()=>({mode:"tags",placeholder:"输入拓展名并按回车或空格添加(例如:.txt,.pdf)"}),label:"必需的拓展名"},{field:"disable_inference_enhance",component:"Switch",label:"禁用推理增强",defaultValue:!0},{field:"inference_deep_thought",component:"Switch",label:"推理深度思考",defaultValue:!1},{field:"enable_hybrid_index",component:"Switch",label:"启用混合索引加速",helpMessage:"使用此功能需先通过byzerllm storage start 启动一个加速引擎以及创建一个名字为emb的向量模型",defaultValue:!1},{field:"hybrid_index_max_output_tokens",component:"InputNumber",label:"混合索引最大输出token数",componentProps:{min:1,max:1e8},defaultValue:"1000000"},{field:"emb_model",label:"向量模型",component:"Select",componentProps:()=>({request:()=>r(),placeholder:"选择向量模型"}),rules:[{required:!0,type:"string",message:"请选择向量模型!"}],vIf:o=>o.values.enable_hybrid_index,defaultValue:""},{field:"rag_storage_type",component:"Select",label:"存储引擎类型",helpMessage:"byzer-storage 需要先安装 Byzer 存储引擎",componentProps:{options:[{label:"DuckDB(默认)",value:"duckdb"},{label:"Byzer Storage",value:"byzer-storage"}]},vIf:o=>o.values.enable_hybrid_index,defaultValue:"duckdb"},{field:"without_contexts",component:"Switch",label:"禁用上下文",defaultValue:!1},{field:"enable_local_image_host",component:"Switch",label:"启动本地图片托管",defaultValue:!1}],ke=V({setup:()=>{const o=k(),[u,l]=C(),i=f({visible:!1,title:"",content:""}),[w]=N(),g=async t=>{const e=await a.ai.getAllRags();let n=8e3;e&&(n=Math.max(...e.map(d=>d.port||8e3))+1);const[s]=await w({modalProps:{title:`${t.name?"编辑":"新增"}模型`,width:"50%",onFinish:async d=>{t.name?await a.ai.updateRag({...d,name:t.name}):await a.ai.addRag(d),l==null||l.reload()}},formProps:{layout:"vertical",schemas:t.name?T:D}});s==null||s.setFieldsValue({rag_doc_filter_relevance:2,host:"127.0.0.1",port:n,required_exts:[],disable_inference_enhance:!0,inference_deep_thought:!1,enable_hybrid_index:!1,hybrid_index_max_output_tokens:1e6,rag_storage_type:"duckdb",without_contexts:!1,enable_local_image_host:!1,product_type:"lite",rag_context_window_limit:56e3,full_text_ratio:.7,segment_ratio:.2,...t})},y=async t=>{await a.ai.deleteRag(t),l==null||l.reload()},v=async t=>{i.value={visible:!0,content:"",title:`${t}: Output`};const e=async()=>{const s=await a.ai.getRagLog(t);s&&(i.value.content=s.log)};await e();const n=setInterval(e,3e3);c.value=n},P=[...G,{title:"操作",width:400,dataIndex:"ACTION",hideInSearch:!0,fixed:"right",actions:({record:t})=>[{label:t.status==="stopped"?"启动":"停止",icon:t.status==="stopped"?"ant-design:poweroff-outlined":"ant-design:pause-circle-outlined",onClick:async()=>{t.status==="stopped"?await a.ai.ragAction({ragName:t.name,action:"start"}):await a.ai.ragAction({ragName:t.name,action:"stop"}),l==null||l.reload()}},{label:"查看日志",icon:"ant-design:eye-outlined",onClick:()=>v(t.name)},{label:"构建缓存",icon:"ant-design:tool-outlined",vShow:t.enable_hybrid_index===!0,onClick:()=>{o.push(`/ai/rag/build_cache/${t.name}`)}},{label:"编辑",icon:"ant-design:edit-outlined",disabled:t.status==="running",onClick:async()=>{const e=await a.ai.getRagByName(t.name);g({name:e.name,model:e.model,description:e.description,recall_model:e.recall_model,chunk_model:e.chunk_model,qa_model:e.qa_model,emb_model:e.emb_model,tokenizer_path:e.tokenizer_path,enable_local_image_host:e.enable_local_image_host,doc_dir:e.doc_dir,rag_doc_filter_relevance:e.rag_doc_filter_relevance,host:e.host,port:e.port,required_exts:e.required_exts,disable_inference_enhance:e.disable_inference_enhance,inference_deep_thought:e.inference_deep_thought,enable_hybrid_index:e.enable_hybrid_index,rag_storage_type:e.rag_storage_type,hybrid_index_max_output_tokens:e.hybrid_index_max_output_tokens,without_contexts:e.without_contexts,product_type:e.product_type,rag_context_window_limit:e.rag_context_window_limit,full_text_ratio:e.full_text_ratio,segment_ratio:e.segment_ratio})}},{label:"删除",icon:"ant-design:delete-outlined",danger:!0,disabled:t.status!=="stopped",popConfirm:{title:"Are you sure you want to delete this rag?",placement:"left",onConfirm:()=>{t.name&&y(t.name)}}}]}],c=f(null),S=()=>{c.value&&(clearInterval(c.value),c.value=null),i.value.visible=!1},m=f(),I=()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)};q(()=>i.value.content,()=>{i.value.visible&&A(()=>{I()})});const b=f([]);return R(()=>{const t=l.tableData;if(Array.isArray(t)){b.value.forEach(n=>{clearInterval(n)});const e=t.filter(n=>n.status==="starting");for(const n of e)if(n.status==="starting"){const s=setInterval(()=>{a.ai.getRagStatus(n.name).then(d=>{d.status==="running"&&(l==null||l.reload(),clearInterval(s))})},1e3);b.value.push(s)}}}),()=>p("div",{class:"w-full h-full overflow-scroll container px-4 py-5"},[p(u,{rowKey:"name",headerTitle:"RAG List",columns:P,bordered:!0,size:"small",dataRequest:a.ai.listRags},{toolbar:()=>p(M,{type:"primary",onClick:()=>g({})},{default:()=>[h("Add")]})}),p(z,{open:i.value.visible,"onUpdate:open":t=>i.value.visible=t,title:i.value.title,onCancel:S,footer:null,width:800,bodyStyle:{maxHeight:"500px",overflow:"auto"}},{default:()=>[p("pre",{ref:m,style:{whiteSpace:"pre-wrap",wordWrap:"break-word",maxHeight:"450px",overflowY:"auto",backgroundColor:"#f5f5f5",padding:"12px",borderRadius:"4px",fontSize:"12px",lineHeight:"1.5",fontFamily:"monospace"}},[i.value.content||"No logs available"])]})])}});export{ke as default};
